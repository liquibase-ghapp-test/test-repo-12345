name: Liquibase Deploy

on:
  push:
    branches: [main]
    paths:
      - 'liquibase/**'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
        default: 'dev'
      runner_label:
        description: 'Runner label (optional)'
        required: false
        type: string
        default: 'ubuntu-latest'

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment || 'dev' }}
    runs-on: ${{ inputs.runner_label || 'ubuntu-latest' }}
    environment: ${{ inputs.environment || 'dev' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Liquibase
        uses: liquibase/setup-liquibase@v2
        with:
          version: '5.0.0'
          edition: 'secure'

      - name: Set environment variables
        id: env
        run: |
          ENV_NAME="${{ inputs.environment || 'dev' }}"
          ENV_UPPER=$(echo "$ENV_NAME" | tr '[:lower:]' '[:upper:]')
          echo "env_name=$ENV_NAME" >> $GITHUB_OUTPUT
          echo "env_upper=$ENV_UPPER" >> $GITHUB_OUTPUT

      - name: Run Liquibase Update
        working-directory: liquibase
        run: |
          liquibase update \
            --changelog-file=changelog.xml \
            --url="${{ secrets[format('LIQUIBASE_{0}_URL', steps.env.outputs.env_upper)] }}" \
            --username="${{ secrets[format('LIQUIBASE_{0}_USERNAME', steps.env.outputs.env_upper)] }}" \
            --password="${{ secrets[format('LIQUIBASE_{0}_PASSWORD', steps.env.outputs.env_upper)] }}"

      - name: Create deployment artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-${{ steps.env.outputs.env_name }}-${{ github.run_number }}
          path: |
            liquibase/changelog.xml
            liquibase/changelogs/
          retention-days: 90
